import React, { useContext, useState } from "react";
import useInput from "@hooks/useInput";
import CircularProgress from "@mui/material/CircularProgress";
import { useNavigate } from "react-router-dom";
import AuthContext from "store/context/auth-context";

import { Button } from "@components/UI/Button";
import {
    Main,
    Header,
    Form,
    Label,
    Input,
    Error,
    LinkContainer,
    AuthContainer,
    Section,
} from "./style";
import Layout from "layouts";
import axios from "axios";
import AuthTimer from "utils/AuthTimer";

const Signup = () => {
    const authCtx = useContext(AuthContext);

    const [isEmailVerified, setIsEmailVerified] = useState(false);
    const [isEmailSending, setIsEmailSending] = useState(null);
    const [emailIsSent, setEmailIsSent] = useState(false);

    const emailRegex = /\S+@\S+\.\S+/;
    const passwordRegex = /^(?=.*[a-zA-Z])(?=.*[0-9]).{8,20}$/;

    const {
        value: nickname,
        isValid: nicknameIsValid,
        hasError: nicknameHasError,
        valueChangeHandler: onChangeNickname,
        inputBlurHandler: onBlurNickname,
    } = useInput((value) => value.trim() !== "");
    const {
        value: email,
        isValid: emailIsValid,
        hasError: emailHasError,
        valueChangeHandler: onChangeEmail,
        inputBlurHandler: onBlurEmail,
    } = useInput((value) => emailRegex.test(value));
    const {
        value: password,
        isValid: passwordIsValid,
        hasError: passwordHasError,
        valueChangeHandler: onChangePassword,
        inputBlurHandler: onBlurPassword,
    } = useInput((value) => passwordRegex.test(value));
    const {
        value: passwordCheck,
        isValid: passwordCheckIsValid,
        hasError: passwordCheckHasError,
        valueChangeHandler: onChangePasswordCheck,
        inputBlurHandler: onBlurPasswordCheck,
    } = useInput((value) => value === password);

    const [authCode, setAuthCode] = useState("");
    const authCodeHandler = (e) => {
        setAuthCode(e.target.value);
    };

    // Î≤ÑÌäº ÌôúÏÑ±Ìôî
    let emailSendBtnActive = false;
    if (emailIsValid) {
        emailSendBtnActive = true;
        if (emailIsSent) {
            emailSendBtnActive = false;
        }
    }

    /* Ïù∏Ï¶ù ÏΩîÎìú Ï†ÑÏÜ°
     *
     * TODO: email Ï†ÑÏÜ° API Ìò∏Ï∂ú
     * - Loading Spinner Ï∂îÍ∞Ä. üÜó
     * - timer Í∏∞Îä• Ï∂îÍ∞Ä. üÜó
     * - setCodeIsExpire ÏÉÅÌÉú Î≥ÄÍ≤Ω.
     *
     */

    const emailSendHandler = (e) => {
        e.preventDefault();
        setIsEmailSending(true);

        axios
            .post("/users/send-email", { email: email })
            .then((response) => {
                setIsEmailSending(false);
                setEmailIsSent(true);

                authCtx.specifyExpirationTime(
                    response.data.data.expireDateTime
                );
            })
            .catch((error) => {
                setIsEmailSending(false);
                console.log(error);
            });
    };

    const isExpired = authCtx.isCodeExpire;

    /* Ïù¥Î©îÏùº Ïù∏Ï¶ù ÏΩîÎìú Ï≤¥ÌÅ¨
     *
     * TODO: email Ïù∏Ï¶ù API Ìò∏Ï∂ú
     *
     */
    const emailVerifyHandler = (e) => {
        e.preventDefault();
        axios
            .post("/users/confirm-email", {
                authCode: authCode,
                email: email,
            })
            .then((response) => {
                console.log(response);
                setIsEmailVerified(true);
            })
            .catch((error) => {
                console.log(error);
            });
    };

    // Form Ïú†Ìö®ÏÑ± Ï≤¥ÌÅ¨
    let formIsValid = false;
    if (
        isEmailVerified &&
        nicknameIsValid &&
        passwordIsValid &&
        passwordCheckIsValid
    ) {
        formIsValid = true;
    }

    /* Form Ï†úÏ∂ú
     *
     * TODO: signup API Ìò∏Ï∂ú
     * - redux(store)Î°ú ÏòÆÍ∏∞Í∏∞.
     * - Loading Spinner Ï∂îÍ∞Ä.
     */
    const navigate = useNavigate();

    const formSubmitHandler = (e) => {
        e.preventDefault();

        if (!formIsValid) {
            return;
        }

        console.log("Ï†ÑÏÜ° ÏôÑÎ£å");

        const credentials = {
            email: email,
            nickname: nickname,
            password: password,
        };

        axios
            .post("users/signup", credentials)
            .then((response) => {
                navigate("/login", { replace: true });
                console.log(response);
            })
            .catch((error) => {
                console.log(error);
            });
    };

    return (
        <Layout auth>
            <Main>
                <Section>
                    <div>
                        <Header>ÌöåÏõêÍ∞ÄÏûÖ</Header>

                        <Form onSubmit={formSubmitHandler}>
                            <Label id="email-label" error={emailHasError}>
                                <span>Ïù¥Î©îÏùº Ï£ºÏÜå</span>
                                <div>
                                    <Input
                                        type="email"
                                        id="email"
                                        name="email"
                                        value={email}
                                        placeholder="Ïù¥Î©îÏùº"
                                        onChange={onChangeEmail}
                                        onBlur={onBlurEmail}
                                        error={emailHasError}
                                        readOnly={emailIsSent}
                                        required
                                    />
                                </div>
                                {emailHasError && (
                                    <Error>Email ÌòïÏãùÏúºÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</Error>
                                )}
                                <Button
                                    type="button"
                                    disabled={!emailSendBtnActive}
                                    onClick={emailSendHandler}
                                >
                                    {isEmailSending ? (
                                        <CircularProgress size={20} />
                                    ) : (
                                        <p>Ïù¥Î©îÏùº Ïù∏Ï¶ùÌïòÍ∏∞</p>
                                    )}
                                </Button>
                                {emailIsSent && (
                                    <AuthContainer isExpire={isExpired}>
                                        <span className="auth-message">
                                            Ïù¥Î©îÏùºÎ°ú Ï†ÑÏÜ°Îêú Ïù∏Ï¶ùÏΩîÎìúÎ•º
                                            ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.
                                        </span>
                                        <div className="auth-container">
                                            <div className="auth-number-container">
                                                <input
                                                    placeholder="Ïù∏Ï¶ùÏΩîÎìú 6ÏûêÎ¶¨"
                                                    onChange={authCodeHandler}
                                                    value={authCode}
                                                />
                                                <span className="timer">
                                                    <AuthTimer />
                                                </span>
                                                <button
                                                    className="auth-button"
                                                    type="button"
                                                    onClick={emailVerifyHandler}
                                                >
                                                    {isEmailSending ? (
                                                        <CircularProgress
                                                            size={20}
                                                        />
                                                    ) : (
                                                        <p>ÌôïÏù∏</p>
                                                    )}
                                                </button>
                                            </div>
                                            {isExpired && (
                                                <div className="expiration-container">
                                                    <span className="expiration-message">
                                                        Ïù∏Ï¶ùÏΩîÎìúÍ∞Ä
                                                        ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.
                                                    </span>
                                                    <div>
                                                        <span>
                                                            Ïù¥Î©îÏùºÏùÑ Î∞õÏßÄ
                                                            Î™ªÌïòÏÖ®ÎÇòÏöî?
                                                        </span>
                                                        <span
                                                            onClick={
                                                                emailSendHandler
                                                            }
                                                        >
                                                            Ïù¥Î©îÏùº Ïû¨Ï†ÑÏÜ°ÌïòÍ∏∞
                                                        </span>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </AuthContainer>
                                )}
                            </Label>

                            <Label id="nickname-label" error={nicknameHasError}>
                                <span>ÎãâÎÑ§ÏûÑ</span>
                                <div>
                                    <Input
                                        type="text"
                                        id="nickname"
                                        name="nickname"
                                        value={nickname}
                                        placeholder="ÎãâÎÑ§ÏûÑ"
                                        onChange={onChangeNickname}
                                        onBlur={onBlurNickname}
                                        error={nicknameHasError}
                                        required
                                    />
                                </div>
                                {nicknameHasError && (
                                    <Error>ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</Error>
                                )}
                            </Label>
                            <Label id="password-label" error={passwordHasError}>
                                <span>ÎπÑÎ∞ÄÎ≤àÌò∏</span>
                                <div>
                                    <Input
                                        type="password"
                                        id="password"
                                        name="password"
                                        value={password}
                                        placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏"
                                        onChange={onChangePassword}
                                        onBlur={onBlurPassword}
                                        error={passwordHasError}
                                        required
                                    />
                                </div>
                                {passwordHasError && (
                                    <Error>
                                        ÎπÑÎ∞ÄÎ≤àÌò∏ ÏñëÏãùÏóê ÎßûÍ≤å ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.
                                    </Error>
                                )}
                            </Label>
                            <Label
                                id="password-check-label"
                                error={passwordCheckHasError}
                            >
                                <span>ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</span>
                                <div>
                                    <Input
                                        type="password"
                                        id="password-check"
                                        name="password-check"
                                        value={passwordCheck}
                                        placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏"
                                        onChange={onChangePasswordCheck}
                                        onBlur={onBlurPasswordCheck}
                                        error={passwordCheckHasError}
                                        required
                                    />
                                </div>
                                {passwordCheckHasError && (
                                    <Error>ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.</Error>
                                )}
                            </Label>
                            <Button type="submit">ÌöåÏõêÍ∞ÄÏûÖ</Button>
                        </Form>
                        <LinkContainer>
                            Ïù¥ÎØ∏ ÌöåÏõêÏù¥Ïã†Í∞ÄÏöî?&nbsp;
                            <a href="/login">Î°úÍ∑∏Ïù∏ ÌïòÎü¨Í∞ÄÍ∏∞</a>
                        </LinkContainer>
                    </div>
                </Section>
            </Main>
        </Layout>
    );
};

export default Signup;
